blueprint:
  name: IKEA BILRESA Scroll Wheel Controller (Matter) V2
  description: |
    Contrôlez jusqu'à 3 lumières avec la télécommande IKEA BILRESA connectée en Matter.

    **Fonctionnalités:**
    - 3 positions LED pour contrôler 3 lumières différentes
    - Rotation de la molette pour ajuster la luminosité (détection fluide)
    - Clics simples, doubles, triples et appui long sur la molette
    - Configuration semi-automatique : moins d'étapes qu'avant

    **Utilisation:**
    - Utilisez le bouton sous les LEDs pour changer de position (LED 1, 2 ou 3)
    - Tournez la molette pour ajuster la luminosité de la lumière active
    - Cliquez sur la molette pour allumer/éteindre ou effectuer d'autres actions
  domain: automation
  source_url: https://github.com/EbGuillaume/blueprints/blob/main/automation/ikea_bilresa_matter.yaml

  input:
    # ========================================
    # SENSORS DE ROTATION (position_actuelle_du_commutateur)
    # ========================================

    sensor_rotation_pos1_cw:
      name: "Sensor Rotation Horaire - Position 1"
      description: "Sélectionnez: Position actuelle du commutateur (1)"
      selector:
        entity:
          filter:
            - domain: sensor
          multiple: false

    sensor_rotation_pos1_ccw:
      name: "Sensor Rotation Anti-horaire - Position 1"
      description: "Sélectionnez: Position actuelle du commutateur (2)"
      selector:
        entity:
          filter:
            - domain: sensor
          multiple: false

    sensor_rotation_pos2_cw:
      name: "Sensor Rotation Horaire - Position 2"
      description: "Sélectionnez: Position actuelle du commutateur (4)"
      selector:
        entity:
          filter:
            - domain: sensor
          multiple: false

    sensor_rotation_pos2_ccw:
      name: "Sensor Rotation Anti-horaire - Position 2"
      description: "Sélectionnez: Position actuelle du commutateur (5)"
      selector:
        entity:
          filter:
            - domain: sensor
          multiple: false

    sensor_rotation_pos3_cw:
      name: "Sensor Rotation Horaire - Position 3"
      description: "Sélectionnez: Position actuelle du commutateur (7)"
      selector:
        entity:
          filter:
            - domain: sensor
          multiple: false

    sensor_rotation_pos3_ccw:
      name: "Sensor Rotation Anti-horaire - Position 3"
      description: "Sélectionnez: Position actuelle du commutateur (8)"
      selector:
        entity:
          filter:
            - domain: sensor
          multiple: false

    # ========================================
    # EVENTS DE CLICS (bouton_X)
    # ========================================

    event_click_pos1:
      name: "Event Clics - Position 1"
      description: "Sélectionnez: Bouton (3)"
      selector:
        entity:
          filter:
            - domain: event
          multiple: false

    event_click_pos2:
      name: "Event Clics - Position 2"
      description: "Sélectionnez: Bouton (6)"
      selector:
        entity:
          filter:
            - domain: event
          multiple: false

    event_click_pos3:
      name: "Event Clics - Position 3"
      description: "Sélectionnez: Bouton (9)"
      selector:
        entity:
          filter:
            - domain: event
          multiple: false

    # ========================================
    # LUMIÈRES
    # ========================================

    light_position_1:
      name: Lumière Position 1 (LED 1)
      description: Lumière contrôlée quand la LED 1 est allumée
      default: []
      selector:
        entity:
          filter:
            - domain: light
          multiple: false

    light_position_2:
      name: Lumière Position 2 (LED 2)
      description: Lumière contrôlée quand la LED 2 est allumée
      default: []
      selector:
        entity:
          filter:
            - domain: light
          multiple: false

    light_position_3:
      name: Lumière Position 3 (LED 3)
      description: Lumière contrôlée quand la LED 3 est allumée
      default: []
      selector:
        entity:
          filter:
            - domain: light
          multiple: false

    # ========================================
    # PARAMÈTRES
    # ========================================

    brightness_step:
      name: Pas de luminosité
      description: Incrément de luminosité par cran de rotation (en %)
      default: 10
      selector:
        number:
          min: 1
          max: 25
          step: 1
          unit_of_measurement: "%"
          mode: slider

    click_action:
      name: Action sur clic simple
      description: Action à effectuer lors d'un clic simple sur la molette
      default: toggle
      selector:
        select:
          options:
            - label: "Allumer/Éteindre (Toggle)"
              value: "toggle"
            - label: "Allumer uniquement"
              value: "turn_on"
            - label: "Éteindre uniquement"
              value: "turn_off"
            - label: "Luminosité 100%"
              value: "brightness_max"
            - label: "Luminosité 50%"
              value: "brightness_50"

    double_click_action:
      name: Action sur double clic
      description: Action à effectuer lors d'un double clic sur la molette
      default: brightness_max
      selector:
        select:
          options:
            - label: "Aucune action"
              value: "none"
            - label: "Allumer/Éteindre (Toggle)"
              value: "toggle"
            - label: "Luminosité 100%"
              value: "brightness_max"
            - label: "Luminosité 50%"
              value: "brightness_50"
            - label: "Luminosité 25%"
              value: "brightness_25"

    triple_click_action:
      name: Action sur triple clic
      description: Action à effectuer lors d'un triple clic sur la molette
      default: none
      selector:
        select:
          options:
            - label: "Aucune action"
              value: "none"
            - label: "Allumer/Éteindre (Toggle)"
              value: "toggle"
            - label: "Luminosité 100%"
              value: "brightness_max"
            - label: "Luminosité 1%"
              value: "brightness_min"

    long_press_action:
      name: Action sur appui long
      description: Action à effectuer lors d'un appui long sur la molette
      default: turn_off
      selector:
        select:
          options:
            - label: "Aucune action"
              value: "none"
            - label: "Éteindre"
              value: "turn_off"
            - label: "Allumer/Éteindre (Toggle)"
              value: "toggle"
            - label: "Luminosité 100%"
              value: "brightness_max"

mode: restart
max_exceeded: silent

variables:
  light_pos_1: !input light_position_1
  light_pos_2: !input light_position_2
  light_pos_3: !input light_position_3
  step_pct: !input brightness_step
  step_value: "{{ (step_pct * 255 / 100) | int }}"

trigger:
  # ========================================
  # POSITION 1 (LED 1) - Sensors rotation + Event clics
  # ========================================

  # Rotation sens horaire - Position 1 (sensor passe à 1)
  - platform: state
    entity_id: !input sensor_rotation_pos1_cw
    to: "1"
    id: rotation_1_cw

  # Rotation sens anti-horaire - Position 1 (sensor passe à 1)
  - platform: state
    entity_id: !input sensor_rotation_pos1_ccw
    to: "1"
    id: rotation_1_ccw

  # Clics molette - Position 1
  - platform: state
    entity_id: !input event_click_pos1
    id: click_1

  # ========================================
  # POSITION 2 (LED 2) - Sensors rotation + Event clics
  # ========================================

  # Rotation sens horaire - Position 2
  - platform: state
    entity_id: !input sensor_rotation_pos2_cw
    to: "1"
    id: rotation_2_cw

  # Rotation sens anti-horaire - Position 2
  - platform: state
    entity_id: !input sensor_rotation_pos2_ccw
    to: "1"
    id: rotation_2_ccw

  # Clics molette - Position 2
  - platform: state
    entity_id: !input event_click_pos2
    id: click_2

  # ========================================
  # POSITION 3 (LED 3) - Sensors rotation + Event clics
  # ========================================

  # Rotation sens horaire - Position 3
  - platform: state
    entity_id: !input sensor_rotation_pos3_cw
    to: "1"
    id: rotation_3_cw

  # Rotation sens anti-horaire - Position 3
  - platform: state
    entity_id: !input sensor_rotation_pos3_ccw
    to: "1"
    id: rotation_3_ccw

  # Clics molette - Position 3
  - platform: state
    entity_id: !input event_click_pos3
    id: click_3

action:
  - variables:
      click_act: !input click_action
      double_click_act: !input double_click_action
      triple_click_act: !input triple_click_action
      long_press_act: !input long_press_action

  - choose:
      # ============================================
      # POSITION 1 (LED 1) - Rotation + Clics
      # ============================================

      # Rotation sens horaire - Position 1
      - conditions:
          - condition: trigger
            id: rotation_1_cw
          - "{{ light_pos_1 != '' and light_pos_1 != [] }}"
        sequence:
          - service: light.turn_on
            target:
              entity_id: !input light_position_1
            data:
              brightness_step: "{{ step_value }}"
              transition: 0.1

      # Rotation sens anti-horaire - Position 1
      - conditions:
          - condition: trigger
            id: rotation_1_ccw
          - "{{ light_pos_1 != '' and light_pos_1 != [] }}"
        sequence:
          - service: light.turn_on
            target:
              entity_id: !input light_position_1
            data:
              brightness_step: "{{ -step_value }}"
              transition: 0.1

      # Clics - Position 1
      - conditions:
          - condition: trigger
            id: click_1
          - "{{ light_pos_1 != '' and light_pos_1 != [] }}"
        sequence:
          - variables:
              event_type: "{{ trigger.to_state.attributes.event_type }}"
              target_light: !input light_position_1

          - choose:
              # Clic simple
              - conditions: "{{ event_type == 'multi_press_1' }}"
                sequence:
                  - choose:
                      - conditions: "{{ click_act == 'toggle' }}"
                        sequence:
                          - service: light.toggle
                            target:
                              entity_id: "{{ target_light }}"
                      - conditions: "{{ click_act == 'turn_on' }}"
                        sequence:
                          - service: light.turn_on
                            target:
                              entity_id: "{{ target_light }}"
                      - conditions: "{{ click_act == 'turn_off' }}"
                        sequence:
                          - service: light.turn_off
                            target:
                              entity_id: "{{ target_light }}"
                      - conditions: "{{ click_act == 'brightness_max' }}"
                        sequence:
                          - service: light.turn_on
                            target:
                              entity_id: "{{ target_light }}"
                            data:
                              brightness_pct: 100
                      - conditions: "{{ click_act == 'brightness_50' }}"
                        sequence:
                          - service: light.turn_on
                            target:
                              entity_id: "{{ target_light }}"
                            data:
                              brightness_pct: 50

              # Double clic
              - conditions: "{{ event_type == 'multi_press_2' and double_click_act != 'none' }}"
                sequence:
                  - choose:
                      - conditions: "{{ double_click_act == 'toggle' }}"
                        sequence:
                          - service: light.toggle
                            target:
                              entity_id: "{{ target_light }}"
                      - conditions: "{{ double_click_act == 'brightness_max' }}"
                        sequence:
                          - service: light.turn_on
                            target:
                              entity_id: "{{ target_light }}"
                            data:
                              brightness_pct: 100
                      - conditions: "{{ double_click_act == 'brightness_50' }}"
                        sequence:
                          - service: light.turn_on
                            target:
                              entity_id: "{{ target_light }}"
                            data:
                              brightness_pct: 50
                      - conditions: "{{ double_click_act == 'brightness_25' }}"
                        sequence:
                          - service: light.turn_on
                            target:
                              entity_id: "{{ target_light }}"
                            data:
                              brightness_pct: 25

              # Triple clic
              - conditions: "{{ event_type == 'multi_press_3' and triple_click_act != 'none' }}"
                sequence:
                  - choose:
                      - conditions: "{{ triple_click_act == 'toggle' }}"
                        sequence:
                          - service: light.toggle
                            target:
                              entity_id: "{{ target_light }}"
                      - conditions: "{{ triple_click_act == 'brightness_max' }}"
                        sequence:
                          - service: light.turn_on
                            target:
                              entity_id: "{{ target_light }}"
                            data:
                              brightness_pct: 100
                      - conditions: "{{ triple_click_act == 'brightness_min' }}"
                        sequence:
                          - service: light.turn_on
                            target:
                              entity_id: "{{ target_light }}"
                            data:
                              brightness_pct: 1

              # Appui long
              - conditions: "{{ event_type == 'long_press' and long_press_act != 'none' }}"
                sequence:
                  - choose:
                      - conditions: "{{ long_press_act == 'turn_off' }}"
                        sequence:
                          - service: light.turn_off
                            target:
                              entity_id: "{{ target_light }}"
                      - conditions: "{{ long_press_act == 'toggle' }}"
                        sequence:
                          - service: light.toggle
                            target:
                              entity_id: "{{ target_light }}"
                      - conditions: "{{ long_press_act == 'brightness_max' }}"
                        sequence:
                          - service: light.turn_on
                            target:
                              entity_id: "{{ target_light }}"
                            data:
                              brightness_pct: 100

      # ============================================
      # POSITION 2 (LED 2) - Rotation + Clics
      # ============================================

      # Rotation sens horaire - Position 2
      - conditions:
          - condition: trigger
            id: rotation_2_cw
          - "{{ light_pos_2 != '' and light_pos_2 != [] }}"
        sequence:
          - service: light.turn_on
            target:
              entity_id: !input light_position_2
            data:
              brightness_step: "{{ step_value }}"
              transition: 0.1

      # Rotation sens anti-horaire - Position 2
      - conditions:
          - condition: trigger
            id: rotation_2_ccw
          - "{{ light_pos_2 != '' and light_pos_2 != [] }}"
        sequence:
          - service: light.turn_on
            target:
              entity_id: !input light_position_2
            data:
              brightness_step: "{{ -step_value }}"
              transition: 0.1

      # Clics - Position 2
      - conditions:
          - condition: trigger
            id: click_2
          - "{{ light_pos_2 != '' and light_pos_2 != [] }}"
        sequence:
          - variables:
              event_type: "{{ trigger.to_state.attributes.event_type }}"
              target_light: !input light_position_2

          - choose:
              # Clic simple
              - conditions: "{{ event_type == 'multi_press_1' }}"
                sequence:
                  - choose:
                      - conditions: "{{ click_act == 'toggle' }}"
                        sequence:
                          - service: light.toggle
                            target:
                              entity_id: "{{ target_light }}"
                      - conditions: "{{ click_act == 'turn_on' }}"
                        sequence:
                          - service: light.turn_on
                            target:
                              entity_id: "{{ target_light }}"
                      - conditions: "{{ click_act == 'turn_off' }}"
                        sequence:
                          - service: light.turn_off
                            target:
                              entity_id: "{{ target_light }}"
                      - conditions: "{{ click_act == 'brightness_max' }}"
                        sequence:
                          - service: light.turn_on
                            target:
                              entity_id: "{{ target_light }}"
                            data:
                              brightness_pct: 100
                      - conditions: "{{ click_act == 'brightness_50' }}"
                        sequence:
                          - service: light.turn_on
                            target:
                              entity_id: "{{ target_light }}"
                            data:
                              brightness_pct: 50

              # Double clic
              - conditions: "{{ event_type == 'multi_press_2' and double_click_act != 'none' }}"
                sequence:
                  - choose:
                      - conditions: "{{ double_click_act == 'toggle' }}"
                        sequence:
                          - service: light.toggle
                            target:
                              entity_id: "{{ target_light }}"
                      - conditions: "{{ double_click_act == 'brightness_max' }}"
                        sequence:
                          - service: light.turn_on
                            target:
                              entity_id: "{{ target_light }}"
                            data:
                              brightness_pct: 100
                      - conditions: "{{ double_click_act == 'brightness_50' }}"
                        sequence:
                          - service: light.turn_on
                            target:
                              entity_id: "{{ target_light }}"
                            data:
                              brightness_pct: 50
                      - conditions: "{{ double_click_act == 'brightness_25' }}"
                        sequence:
                          - service: light.turn_on
                            target:
                              entity_id: "{{ target_light }}"
                            data:
                              brightness_pct: 25

              # Triple clic
              - conditions: "{{ event_type == 'multi_press_3' and triple_click_act != 'none' }}"
                sequence:
                  - choose:
                      - conditions: "{{ triple_click_act == 'toggle' }}"
                        sequence:
                          - service: light.toggle
                            target:
                              entity_id: "{{ target_light }}"
                      - conditions: "{{ triple_click_act == 'brightness_max' }}"
                        sequence:
                          - service: light.turn_on
                            target:
                              entity_id: "{{ target_light }}"
                            data:
                              brightness_pct: 100
                      - conditions: "{{ triple_click_act == 'brightness_min' }}"
                        sequence:
                          - service: light.turn_on
                            target:
                              entity_id: "{{ target_light }}"
                            data:
                              brightness_pct: 1

              # Appui long
              - conditions: "{{ event_type == 'long_press' and long_press_act != 'none' }}"
                sequence:
                  - choose:
                      - conditions: "{{ long_press_act == 'turn_off' }}"
                        sequence:
                          - service: light.turn_off
                            target:
                              entity_id: "{{ target_light }}"
                      - conditions: "{{ long_press_act == 'toggle' }}"
                        sequence:
                          - service: light.toggle
                            target:
                              entity_id: "{{ target_light }}"
                      - conditions: "{{ long_press_act == 'brightness_max' }}"
                        sequence:
                          - service: light.turn_on
                            target:
                              entity_id: "{{ target_light }}"
                            data:
                              brightness_pct: 100

      # ============================================
      # POSITION 3 (LED 3) - Rotation + Clics
      # ============================================

      # Rotation sens horaire - Position 3
      - conditions:
          - condition: trigger
            id: rotation_3_cw
          - "{{ light_pos_3 != '' and light_pos_3 != [] }}"
        sequence:
          - service: light.turn_on
            target:
              entity_id: !input light_position_3
            data:
              brightness_step: "{{ step_value }}"
              transition: 0.1

      # Rotation sens anti-horaire - Position 3
      - conditions:
          - condition: trigger
            id: rotation_3_ccw
          - "{{ light_pos_3 != '' and light_pos_3 != [] }}"
        sequence:
          - service: light.turn_on
            target:
              entity_id: !input light_position_3
            data:
              brightness_step: "{{ -step_value }}"
              transition: 0.1

      # Clics - Position 3
      - conditions:
          - condition: trigger
            id: click_3
          - "{{ light_pos_3 != '' and light_pos_3 != [] }}"
        sequence:
          - variables:
              event_type: "{{ trigger.to_state.attributes.event_type }}"
              target_light: !input light_position_3

          - choose:
              # Clic simple
              - conditions: "{{ event_type == 'multi_press_1' }}"
                sequence:
                  - choose:
                      - conditions: "{{ click_act == 'toggle' }}"
                        sequence:
                          - service: light.toggle
                            target:
                              entity_id: "{{ target_light }}"
                      - conditions: "{{ click_act == 'turn_on' }}"
                        sequence:
                          - service: light.turn_on
                            target:
                              entity_id: "{{ target_light }}"
                      - conditions: "{{ click_act == 'turn_off' }}"
                        sequence:
                          - service: light.turn_off
                            target:
                              entity_id: "{{ target_light }}"
                      - conditions: "{{ click_act == 'brightness_max' }}"
                        sequence:
                          - service: light.turn_on
                            target:
                              entity_id: "{{ target_light }}"
                            data:
                              brightness_pct: 100
                      - conditions: "{{ click_act == 'brightness_50' }}"
                        sequence:
                          - service: light.turn_on
                            target:
                              entity_id: "{{ target_light }}"
                            data:
                              brightness_pct: 50

              # Double clic
              - conditions: "{{ event_type == 'multi_press_2' and double_click_act != 'none' }}"
                sequence:
                  - choose:
                      - conditions: "{{ double_click_act == 'toggle' }}"
                        sequence:
                          - service: light.toggle
                            target:
                              entity_id: "{{ target_light }}"
                      - conditions: "{{ double_click_act == 'brightness_max' }}"
                        sequence:
                          - service: light.turn_on
                            target:
                              entity_id: "{{ target_light }}"
                            data:
                              brightness_pct: 100
                      - conditions: "{{ double_click_act == 'brightness_50' }}"
                        sequence:
                          - service: light.turn_on
                            target:
                              entity_id: "{{ target_light }}"
                            data:
                              brightness_pct: 50
                      - conditions: "{{ double_click_act == 'brightness_25' }}"
                        sequence:
                          - service: light.turn_on
                            target:
                              entity_id: "{{ target_light }}"
                            data:
                              brightness_pct: 25

              # Triple clic
              - conditions: "{{ event_type == 'multi_press_3' and triple_click_act != 'none' }}"
                sequence:
                  - choose:
                      - conditions: "{{ triple_click_act == 'toggle' }}"
                        sequence:
                          - service: light.toggle
                            target:
                              entity_id: "{{ target_light }}"
                      - conditions: "{{ triple_click_act == 'brightness_max' }}"
                        sequence:
                          - service: light.turn_on
                            target:
                              entity_id: "{{ target_light }}"
                            data:
                              brightness_pct: 100
                      - conditions: "{{ triple_click_act == 'brightness_min' }}"
                        sequence:
                          - service: light.turn_on
                            target:
                              entity_id: "{{ target_light }}"
                            data:
                              brightness_pct: 1

              # Appui long
              - conditions: "{{ event_type == 'long_press' and long_press_act != 'none' }}"
                sequence:
                  - choose:
                      - conditions: "{{ long_press_act == 'turn_off' }}"
                        sequence:
                          - service: light.turn_off
                            target:
                              entity_id: "{{ target_light }}"
                      - conditions: "{{ long_press_act == 'toggle' }}"
                        sequence:
                          - service: light.toggle
                            target:
                              entity_id: "{{ target_light }}"
                      - conditions: "{{ long_press_act == 'brightness_max' }}"
                        sequence:
                          - service: light.turn_on
                            target:
                              entity_id: "{{ target_light }}"
                            data:
                              brightness_pct: 100
